<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Category Map</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    #map {
      height: 55vh;
      border-radius: 0.75rem;
      transition: height 0.3s ease;
    }
    #locationList {
      max-height: 28vh;
      overflow-y: auto;
    }
    /* Make emoji marker look nice */
    .emoji-marker {
      font-size: 28px;
      text-shadow: 0 0 2px #000;
      line-height: 1;
    }
    /* Scrollbar for location list */
    #locationList::-webkit-scrollbar {
      width: 8px;
    }
    #locationList::-webkit-scrollbar-thumb {
      background-color: rgba(100, 116, 139, 0.6);
      border-radius: 4px;
    }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">

  <header
    id="header"
    class="bg-blue-900 text-white text-center text-2xl font-bold p-4 relative shadow-lg"
  >
    Loading...
    <button
      id="toggleMode"
      class="absolute right-5 top-1/2 -translate-y-1/2 text-white hover:text-blue-300"
      title="Toggle Dark/Light Mode"
    >
      üåô
    </button>
    <button
      id="backBtn"
      class="absolute left-5 top-1/2 -translate-y-1/2 bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded"
      title="Back to Categories"
    >
      ‚Üê Categories
    </button>
  </header>

  <div
    id="form-container"
    class="bg-gray-800 p-4 flex flex-wrap gap-4 justify-center items-center shadow-md"
  >
    <input
      id="locationName"
      type="text"
      placeholder="Location Name"
      class="flex-1 min-w-[200px] px-4 py-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-400"
    />
    <input
      id="address"
      type="text"
      placeholder="Address"
      class="flex-1 min-w-[200px] px-4 py-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-400"
    />
    <button
      id="addLocationBtn"
      class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-3 rounded-lg"
    >
      Add Location
    </button>

    <button
      id="clearStorageBtn"
      class="bg-red-600 hover:bg-red-700 text-white font-semibold px-6 py-3 rounded-lg"
      title="Clear All Saved Locations"
    >
      Clear All Data
    </button>
  </div>

  <!-- New Controls: Search and Sort -->
  <div class="bg-gray-800 p-4 flex flex-wrap gap-4 justify-center items-center shadow-md mt-4 max-w-4xl mx-auto rounded-lg">
    <input
      id="searchLocations"
      type="text"
      placeholder="Search locations..."
      class="flex-1 min-w-[200px] px-4 py-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-400"
    />
    <select
      id="sortLocations"
      class="min-w-[150px] px-3 py-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-400"
      title="Sort locations"
    >
      <option value="name_asc">Name A-Z</option>
      <option value="visited_first">Visited First</option>
      <option value="newest_first">Newest First</option>
    </select>
    <button
      id="toggleAllVisitedBtn"
      class="bg-green-600 hover:bg-green-700 text-white font-semibold px-5 py-3 rounded-lg"
      title="Toggle Visited Status for All"
    >
      Mark All Visited
    </button>
    <button
      id="exportJSONBtn"
      class="bg-yellow-500 hover:bg-yellow-600 text-black font-semibold px-5 py-3 rounded-lg"
      title="Export locations as JSON"
    >
      Export JSON
    </button>
  </div>

  <div id="map" class="m-5 shadow-lg"></div>

  <div
    id="locationSummary"
    class="m-5 rounded-lg shadow-lg bg-gray-800 text-white p-4 font-semibold text-center max-w-4xl mx-auto"
  ></div>

  <div
    id="locationList"
    class="m-5 rounded-lg shadow-lg bg-gray-800 text-white p-4 max-h-[28vh] overflow-y-auto max-w-4xl mx-auto"
  ></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    function getQueryParam(param) {
      const params = new URLSearchParams(window.location.search);
      return params.get(param);
    }

    const presetCategories = {
      foods: {
        name: "Delhi Food Manufacturers Map",
        storageKey: "locations_foods",
        emoji: "üçî",
      },
      jeans: {
        name: "Delhi Jeans Manufacturers Map",
        storageKey: "locations_jeans",
        emoji: "üëñ",
      },
      immigrant: {
        name: "Immigrant Services Map",
        storageKey: "locations_immigrant",
        emoji: "üß≥",
      },
      health: {
        name: "Health Services Map",
        storageKey: "locations_health",
        emoji: "üíä",
      },
      education: {
        name: "Education Centers Map",
        storageKey: "locations_education",
        emoji: "üìö",
      },
    };

    function getCustomCategories() {
      return JSON.parse(localStorage.getItem("custom_categories") || "{}");
    }

    const categoryId = getQueryParam("category");

    let STORAGE_KEY, MAP_TITLE, categoryEmoji;

    if (presetCategories[categoryId]) {
      STORAGE_KEY = presetCategories[categoryId].storageKey;
      MAP_TITLE = presetCategories[categoryId].name;
      categoryEmoji = presetCategories[categoryId].emoji;
    } else {
      const customCategories = getCustomCategories();
      if (customCategories[categoryId]) {
        STORAGE_KEY = `locations_${categoryId}`;
        MAP_TITLE = customCategories[categoryId].label + " Map";
        categoryEmoji = customCategories[categoryId].emoji;
      } else {
        STORAGE_KEY = "locations_default";
        MAP_TITLE = "Default Map";
        categoryEmoji = "üìç";
      }
    }

    categoryEmoji = getQueryParam("emoji") || categoryEmoji;

    const darkTiles = "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png";
    const lightTiles = "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";

    let isDarkMode = true;

    const map = L.map("map").setView([28.6139, 77.209], 12);

    const darkLayer = L.tileLayer(darkTiles, {
      attribution: "&copy; OpenStreetMap & CartoDB",
      maxZoom: 20,
      subdomains: "abcd",
    });

    const lightLayer = L.tileLayer(lightTiles, {
      attribution: "&copy; OpenStreetMap contributors",
      maxZoom: 20,
    });

    darkLayer.addTo(map);

    const markers = [];

    function createEmojiIcon(emoji) {
      return new L.DivIcon({
        className: "emoji-marker",
        html: emoji,
        iconSize: [30, 42],
        iconAnchor: [15, 42],
        popupAnchor: [0, -42],
      });
    }

    const header = document.getElementById("header");
    header.firstChild.textContent = `${categoryEmoji} ${MAP_TITLE}`;

    function loadLocations() {
      return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    }
    function saveLocations(data) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function addMarker(data, index) {
      const icon = createEmojiIcon(categoryEmoji);
      const marker = L.marker([data.lat, data.lng], { icon }).addTo(map);

      markers[index] = { marker, ...data };
      updatePopup(index);
      marker.openPopup();
    }

    function updatePopup(index) {
      const item = markers[index];
      const feedbackText = item.feedback
        ? `<br><b>Feedback:</b> <span style="color:#000">${item.feedback}</span>`
        : "";
      const visitText = item.visited ? "Mark as Not Visited" : "Mark as Visited";

      item.marker.bindPopup(` 
        <div style="color:#000;">
          <b>${item.name}</b><br>${item.address}<br>
        </div>
        <button onclick="toggleVisited(${index})" style="margin-top:8px; padding:6px 12px; background-color:#16a34a; color:#fff; border:none; border-radius:4px; cursor:pointer;">
          ${visitText}
        </button><br><br>
        <button onclick="addFeedback(${index})" style="padding:6px 12px; background-color:#eab308; color:#000000; border:none; border-radius:4px; cursor:pointer;">
          Add/View Feedback
        </button>
        <div style="color:#000; margin-top:6px;">${feedbackText}</div>
      `);
    }

    window.toggleVisited = function (index) {
      const item = markers[index];
      item.visited = !item.visited;

      const saved = loadLocations();
      if (saved[index]) saved[index].visited = item.visited;
      saveLocations(saved);

      updatePopup(index);
      renderLocationList();
    };

    window.addFeedback = function (index) {
      const item = markers[index];
      const feedback = prompt("Please enter your feedback:", item.feedback || "");
      if (feedback !== null) {
        item.feedback = feedback;
        const saved = loadLocations();
        if (saved[index]) saved[index].feedback = feedback;
        saveLocations(saved);
        updatePopup(index);
        renderLocationList();
      }
    };

    window.deleteLocation = function (index) {
      map.removeLayer(markers[index].marker);
      markers.splice(index, 1);

      const saved = loadLocations();
      saved.splice(index, 1);
      saveLocations(saved);

      map.eachLayer((layer) => {
        if (layer instanceof L.Marker) map.removeLayer(layer);
      });
      markers.length = 0;
      saved.forEach((loc, i) => addMarker(loc, i));

      renderLocationList();
    };

    function renderLocationList(filter = "", sortBy = "name_asc") {
      const container = document.getElementById("locationList");
      const summary = document.getElementById("locationSummary");
      let saved = loadLocations();

      // Filter locations by name or address (case insensitive)
      if (filter) {
        const lowerFilter = filter.toLowerCase();
        saved = saved.filter(
          (loc) =>
            loc.name.toLowerCase().includes(lowerFilter) ||
            loc.address.toLowerCase().includes(lowerFilter)
        );
      }

      // Sort locations based on selected sort option
      if (sortBy === "name_asc") {
        saved.sort((a, b) => a.name.localeCompare(b.name));
      } else if (sortBy === "visited_first") {
        saved.sort((a, b) => {
          if (a.visited === b.visited) return 0;
          return a.visited ? -1 : 1;
        });
      } else if (sortBy === "newest_first") {
        saved = saved.reverse();
      }

      container.innerHTML = "";

      const total = saved.length;
      const allSaved = loadLocations();
      const visitedCount = allSaved.filter((loc) => loc.visited).length;
      const notVisitedCount = allSaved.length - visitedCount;

      summary.innerHTML = `
        Total: <span class="text-blue-400">${allSaved.length}</span> | 
        Visited: <span class="text-green-400">${visitedCount}</span> | 
        Not Visited: <span class="text-red-400">${notVisitedCount}</span>
      `;

      if (total === 0) {
        container.innerHTML = `<div class='text-gray-400 text-center'>No locations found.</div>`;
        return;
      }

      saved.forEach((item, index) => {
        const row = document.createElement("div");
        row.className = "flex justify-between items-center bg-gray-700 p-3 rounded mb-2 cursor-pointer hover:bg-gray-600 transition";
        row.innerHTML = `
          <div>
            <div class="font-semibold text-blue-300">${item.name}</div>
            <div class="text-sm text-gray-300">${item.address}</div>
            ${
              item.visited
                ? `<span class="text-green-400 text-xs">Visited</span>`
                : `<span class="text-red-400 text-xs">Not Visited</span>`
            }
          </div>
          <div class="flex gap-2">
            <button onclick="toggleVisited(${index})" class="text-xs bg-green-600 hover:bg-green-700 px-2 py-1 rounded">Toggle Visit</button>
            <button onclick="addFeedback(${index})" class="text-xs bg-yellow-500 hover:bg-yellow-600 text-black px-2 py-1 rounded">Feedback</button>
            <button onclick="deleteLocation(${index})" class="text-xs bg-red-600 hover:bg-red-700 px-2 py-1 rounded">Delete</button>
          </div>
        `;

        // Clicking row except buttons opens popup
        row.addEventListener("click", (e) => {
          if (e.target.tagName.toLowerCase() !== "button") openPopupForIndex(index);
        });

        container.appendChild(row);
      });
    }

    function openPopupForIndex(index) {
      const item = markers[index];
      if (!item) return;
      map.setView([item.lat, item.lng], 16);
      item.marker.openPopup();
    }

    async function geocode(address) {
      const response = await fetch(
        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ", Delhi")}`
      );
      const data = await response.json();
      return data.length ? [parseFloat(data[0].lat), parseFloat(data[0].lon)] : null;
    }

    async function addLocation() {
      const nameInput = document.getElementById("locationName");
      const addressInput = document.getElementById("address");

      const name = nameInput.value.trim();
      const address = addressInput.value.trim();

      if (!name || !address) {
        alert("Please enter both name and address.");
        return;
      }

      const latlng = await geocode(address);
      if (!latlng) {
        alert("Location not found.");
        return;
      }

      const offsetLat = latlng[0] + (Math.random() - 0.5) * 0.0008;
      const offsetLng = latlng[1] + (Math.random() - 0.5) * 0.0008;

      const locationData = {
        name,
        address,
        lat: offsetLat,
        lng: offsetLng,
        visited: false,
        feedback: "",
      };

      const allLocations = loadLocations();
      allLocations.push(locationData);
      saveLocations(allLocations);
      addMarker(locationData, markers.length);
      renderLocationList();

      nameInput.value = "";
      addressInput.value = "";
    }

    // Toggle visited status for all locations
    function toggleAllVisited() {
      const allLocations = loadLocations();
      const allVisited = allLocations.every(loc => loc.visited);
      const newStatus = !allVisited;
      allLocations.forEach(loc => loc.visited = newStatus);
      saveLocations(allLocations);

      // Update markers and list
      markers.forEach((marker, i) => {
        marker.visited = newStatus;
        updatePopup(i);
      });
      renderLocationList(document.getElementById("searchLocations").value, document.getElementById("sortLocations").value);

      const btn = document.getElementById("toggleAllVisitedBtn");
      btn.textContent = newStatus ? "Mark All Not Visited" : "Mark All Visited";
    }

    // Export locations as JSON file download
    function exportLocations() {
      const data = loadLocations();
      if (!data.length) {
        alert("No locations to export.");
        return;
      }
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `${categoryId || "category"}_locations.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    document.getElementById("toggleMode").onclick = () => {
      isDarkMode = !isDarkMode;

      document.body.classList.toggle("bg-white");
      document.body.classList.toggle("text-black");
      document.body.classList.toggle("bg-gray-900");
      document.body.classList.toggle("text-white");

      map.removeLayer(isDarkMode ? lightLayer : darkLayer);
      (isDarkMode ? darkLayer : lightLayer).addTo(map);

      document.getElementById("toggleMode").textContent = isDarkMode ? "üåô" : "‚òÄÔ∏è";
    };

    document.getElementById("backBtn").onclick = () => {
      window.location.href = "index.html";
    };

    document.getElementById("clearStorageBtn").onclick = () => {
      if (confirm("Are you sure you want to clear all saved locations for this category?")) {
        localStorage.removeItem(STORAGE_KEY);

        markers.forEach((m) => map.removeLayer(m.marker));
        markers.length = 0;

        renderLocationList();
      }
    };

    document.getElementById("addLocationBtn").onclick = addLocation;
    document.getElementById("toggleAllVisitedBtn").onclick = toggleAllVisited;
    document.getElementById("exportJSONBtn").onclick = exportLocations;

    // Search input realtime filtering
    document.getElementById("searchLocations").addEventListener("input", (e) => {
      renderLocationList(e.target.value, document.getElementById("sortLocations").value);
    });

    // Sort dropdown change event
    document.getElementById("sortLocations").addEventListener("change", (e) => {
      renderLocationList(document.getElementById("searchLocations").value, e.target.value);
    });

    window.onload = () => {
      const savedLocations = loadLocations();
      savedLocations.forEach((loc, i) => addMarker(loc, i));
      renderLocationList();

      header.firstChild.textContent = `${categoryEmoji} ${MAP_TITLE}`;

      // Set toggle all visited button initial text
      const toggleBtn = document.getElementById("toggleAllVisitedBtn");
      const allVisited = savedLocations.length && savedLocations.every(loc => loc.visited);
      toggleBtn.textContent = allVisited ? "Mark All Not Visited" : "Mark All Visited";
    };

    // Responsive: adjust map height on smaller screens
    window.addEventListener("resize", () => {
      const mapDiv = document.getElementById("map");
      if(window.innerWidth < 640) {
        mapDiv.style.height = "45vh";
      } else {
        mapDiv.style.height = "55vh";
      }
    });
  </script>
</body>
</html>
